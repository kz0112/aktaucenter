<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>AI Geo 3D Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Three.js CDN -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0b1020, #050711 40%, #020308);
      color: #f5f7ff;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      padding: 10px 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(53, 84, 209, 0.8), rgba(74, 222, 128, 0.18));
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(14px);
    }

    header .title {
      font-size: 18px;
      font-weight: 600;
    }

    header .subtitle {
      font-size: 13px;
      opacity: 0.9;
    }

    header .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background: rgba(0, 0, 0, 0.15);
    }

    .layout {
      flex: 1;
      display: flex;
      gap: 12px;
      min-height: 0;
    }

    .chat-panel,
    .viewer-panel {
      background: radial-gradient(circle at top, rgba(26, 31, 55, 0.98), rgba(9, 10, 23, 0.96));
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .chat-panel {
      flex: 1.1;
    }

    .viewer-panel {
      flex: 1;
    }

    .panel-header {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header span {
      opacity: 0.85;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      opacity: 0.8;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 90%;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: #f9fafb;
      border-bottom-right-radius: 4px;
    }

    .msg.bot {
      align-self: flex-start;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.5);
      border-bottom-left-radius: 4px;
    }

    .msg.system {
      align-self: center;
      font-size: 11px;
      opacity: 0.7;
      background: transparent;
      border: none;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(51, 65, 85, 0.9);
    }

    #user-input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }

    #user-input::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    #send-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #6366f1, #22c55e);
      color: #f9fafb;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    #send-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    #send-btn:not(:disabled):active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 16px rgba(37, 99, 235, 0.5);
    }

    #three-container {
      flex: 1;
      border-radius: 14px;
      overflow: hidden;
      background: radial-gradient(circle at center, #020617, #000);
      border: 1px solid rgba(30, 64, 175, 0.7);
      position: relative;
      min-height: 260px;
    }

    .hint {
      font-size: 11px;
      opacity: 0.65;
      margin-top: 6px;
    }

    .legend {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .legend code {
      background: rgba(15, 23, 42, 0.9);
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    @media (max-width: 900px) {
      body {
        height: auto;
      }
      .app {
        height: auto;
      }
      .layout {
        flex-direction: column;
      }
      .chat-panel,
      .viewer-panel {
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">AI Geo 3D • Күрделі геометриялық денелер</div>
        <div class="subtitle">
          ИИ өлшемдер бойынша 3D-модель құруға көмектеседі (куб, сфера, цилиндр, конус, т.б.).
        </div>
      </div>
      <div class="badge">Demo • Frontend only</div>
    </header>

    <main class="layout">
      <!-- CHAT -->
      <section class="chat-panel">
        <div class="panel-header">
          <span>Чат-бот (ИИ + API)</span>
          <span class="pill">gpt-4.1-mini · geometry</span>
        </div>

        <div id="messages"></div>

        <div class="input-row">
          <input
            id="user-input"
            type="text"
            placeholder="Мысалы: «радиусы 1 м, биіктігі 2 м цилиндр құрып бер»"
          />
          <button id="send-btn">Жіберу</button>
        </div>
        <div class="hint">
          Enter – жіберу. ИИ жауаптың соңында JSON-форматта дененің параметрлерін береді, ал оң жақта 3D-модель
          автоматты түрде жаңартылады.
        </div>
      </section>

      <!-- 3D VIEWER -->
      <section class="viewer-panel">
        <div class="panel-header">
          <span>3D-көру аймағы</span>
          <span class="pill">Three.js · OrbitControls</span>
        </div>
        <div id="three-container"></div>
        <div class="legend">
          Тінтуір: айналдыру · <code>drag</code>, масштабтау · <code>scroll</code>, жылжыту · <code>right drag</code>.
        </div>
      </section>
    </main>
  </div>

  <script>
    /***********************
     * 1. API SETTINGS
     ***********************/
    // Frontend енді тікелей OpenAI-ға емес, өз Node.js серверіңе барады
    const API_URL = "/api/chat";
    const MODEL_ID = "gpt-4.1-mini"; // Тек инфо ретінде, нақты модель backend-та
  
      const SYSTEM_PROMPT = `
  Сен – геометриялық 3D-денелерді модельдеуге көмектесетін ассистентсің.
  ӘРҚАШАН ҚАЗАҚ ТІЛІНДЕ ЖАУАП БЕР.
  
  Мақсат:
  1) Студентке қысқа түсініктеме беру.
  2) Соңында бір жолға JSON объект беру, ол 3D-модельді салуға қолданылады.
  
  Формат (міндетті):
  Алдымен түсіндірме мәтін жазың.
  Сосын жаңа жолдан дәл былай баста: "JSON:" және тек JSON бер:
  {
    "shape": "box" | "sphere" | "cylinder" | "cone" | "torus",
    "dimensions": {
      "width": number,      // тек box үшін
      "height": number,     // box, cylinder, cone үшін
      "depth": number,      // box үшін
      "radius": number,     // sphere, cylinder (радиус), torus (негізгі радиус)
      "radiusTop": number,  // cone, cylinder (жоғарғы радиус, қажет болса)
      "radiusBottom": number, // cone, cylinder (төменгі радиус)
      "tube": number        // torus үшін (сақинаның қалыңдығы)
    },
    "color": "#RRGGBB"
  }
  
  Талаптар:
  - Барлық өлшем бірлігі – МЕТР. Пайдаланушы сантиметрмен жазса, метрге өзің аудар.
  - Қажет емес өрістерді JSON ішінде тастап кет (мысалы, сферада тек radius қолдан).
  - color үшін қарапайым түс таңда (мысалы "#22c55e" немесе "#3b82f6").
  
  Мысалы, цилиндр: shape="cylinder", dimensions: { "radius": 1, "height": 2 }.
  `;
  
    /***********************
     * 2. CHAT UI
     ***********************/
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
  
    let chatHistory = [
      { role: "system", content: SYSTEM_PROMPT }
    ];
  
    function addMessage(text, who = "bot") {
      const div = document.createElement("div");
      div.classList.add("msg", who);
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  
    // Бастапқы system-hint
    addMessage(
      "Сәлем! Маған дененің түрін және өлшемдерін жазыңыз.\n" +
      "Мысалы: «ені 1 м, биіктігі 2 м, тереңдігі 0.5 м параллелепипед» немесе «радиусы 0.7 м сфера».\n" +
      "Мен сипаттап, 3D-модельді оң жақта саламын.",
      "bot"
    );
  
    async function callAI(userMessage) {
      chatHistory.push({ role: "user", content: userMessage });
  
      const payload = {
        messages: chatHistory
      };
  
      const response = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
  
      if (!response.ok) {
        const errorText = await response.text();
        console.error("Backend/API error:", errorText);
        throw new Error("API error: " + response.status);
      }
  
      const data = await response.json();
      const assistantMessage = data.choices[0].message.content;
      chatHistory.push({ role: "assistant", content: assistantMessage });
      return assistantMessage;
    }
  
    function extractJsonSpecFromMessage(message) {
      // "JSON:" деген жерден кейін тұрған текстті JSON деп парсимыз
      const idx = message.indexOf("JSON:");
      if (idx === -1) return null;
      const jsonPart = message.slice(idx + 5).trim();
  
      try {
        return JSON.parse(jsonPart);
      } catch (e) {
        console.warn("JSON parse error:", e);
        return null;
      }
    }
  
    async function handleSend() {
      const text = inputEl.value.trim();
      if (!text) return;
  
      addMessage(text, "user");
      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;
  
      try {
  const aiText = await callAI(text);   // AI-дің толық жауабы (мәтін + ішкі деректер)
  console.log("AI raw:", aiText);

  // ---- 1. Пайдаланушыға көрінетін бөлігін бөлу ----
  let visible = aiText;

  // Егер AI ```json ... ``` форматында жіберсе – код блогынан бұрынғысын ғана аламыз
  let jsonStart = aiText.indexOf("```json");
  if (jsonStart !== -1) {
    visible = aiText.slice(0, jsonStart).trim();
  } else {
    // Әйтпесе бірінші "{"-қа дейінгі бөлігін аламыз
    jsonStart = aiText.indexOf("{");
    if (jsonStart !== -1) {
      visible = aiText.slice(0, jsonStart).trim();
    }
  }

  // Егер ешқандай түсіндірме болмаған болса
  if (!visible) {
    visible = "3D үлгісі дайын."; // БҰЛ ЖЕРДЕ ДЕ "JSON" ЖОҚ
  }

  // Мәтіннің өзінен де "JSON" сөзін алып тастаймыз
  visible = visible.replace(/JSON/gi, "").replace(/Json/gi, "").trim();

  // Чатта ТЕК осы тазаланған мәтін көрсетіледі
  addMessage(visible, "bot");

  // ---- 2. 3D үшін толық жауаптан спецификацияны шығарамыз ----
  const spec = extractJsonSpecFromMessage(aiText);
  if (spec) {
    buildShapeFromSpec(spec);
  } else {
    console.warn("No valid shape spec found in AI message.");
  }
} catch (err) {
  console.error(err);
  addMessage("Қате орын алды. Сервер немесе API баптауларын тексеріңіз.", "bot");
} finally {
  sendBtn.disabled = false;
}

    }
  
    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
  
    /***********************
     * 3. THREE.JS SCENE
     *  (осы блок бұрынғы кодтағыдай – тек көшіріп қойдық)
     ***********************/
    const container = document.getElementById("three-container");
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);
  
    const camera = new THREE.PerspectiveCamera(
      45,
      container.clientWidth / container.clientHeight,
      0.1,
      100
    );
    camera.position.set(3, 2, 4);
  
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    container.appendChild(renderer.domElement);
  
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
  
    const hemiLight = new THREE.HemisphereLight(0x9ca3af, 0x020617, 0.85);
    scene.add(hemiLight);
  
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
    dirLight.position.set(4, 6, 3);
    scene.add(dirLight);
  
    const grid = new THREE.GridHelper(20, 20, 0x4b5563, 0x111827);
    grid.position.y = -0.001;
    scene.add(grid);
  
    let currentMesh = null;
  
    function buildShapeFromSpec(spec) {
      try {
        const shape = (spec.shape || "box").toLowerCase();
        const dims = spec.dimensions || {};
        const color = spec.color || "#22c55e";
  
        let geometry = null;
  
        if (shape === "box" || shape === "cube" || shape === "cuboid") {
          const width = dims.width || 1;
          const height = dims.height || 1;
          const depth = dims.depth || 1;
          geometry = new THREE.BoxGeometry(width, height, depth);
        } else if (shape === "sphere") {
          const radius = dims.radius || 1;
          geometry = new THREE.SphereGeometry(radius, 48, 32);
        } else if (shape === "cylinder") {
          const radius = dims.radius || 1;
          const height = dims.height || 2;
          const radiusTop = dims.radiusTop !== undefined ? dims.radiusTop : radius;
          const radiusBottom = dims.radiusBottom !== undefined ? dims.radiusBottom : radius;
          geometry = new THREE.CylinderGeometry(radiusTop, radiusBottom, height, 48, 1);
        } else if (shape === "cone") {
          const radiusBottom = dims.radiusBottom || dims.radius || 1;
          const height = dims.height || 2;
          geometry = new THREE.ConeGeometry(radiusBottom, height, 48, 1);
        } else if (shape === "torus") {
          const radius = dims.radius || 1; // негізгі радиус
          const tube = dims.tube || 0.3;
          geometry = new THREE.TorusGeometry(radius, tube, 32, 64);
        } else {
          const width = dims.width || 1;
          const height = dims.height || 1;
          const depth = dims.depth || 1;
          geometry = new THREE.BoxGeometry(width, height, depth);
        }
  
        const material = new THREE.MeshStandardMaterial({
          color: new THREE.Color(color),
          metalness: 0.2,
          roughness: 0.35
        });
  
        const mesh = new THREE.Mesh(geometry, material);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
  
        if (currentMesh) {
          scene.remove(currentMesh);
          currentMesh.geometry.dispose();
          currentMesh.material.dispose();
        }
  
        mesh.position.set(
          0,
          geometry.boundingSphere ? geometry.boundingSphere.radius / 2 : 0.5,
          0
        );
        scene.add(mesh);
        currentMesh = mesh;
  
        controls.target.set(0, mesh.position.y, 0);
        controls.update();
      } catch (e) {
        console.error("Error building shape from spec:", e);
      }
    }
  
    // Бастапқы демонстрациялық куб
    buildShapeFromSpec({
      shape: "box",
      dimensions: { width: 1.2, height: 1, depth: 0.8 },
      color: "#3b82f6"
    });
  
    function onWindowResize() {
      const w = container.clientWidth;
      const h = container.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
  
    window.addEventListener("resize", onWindowResize);
  
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
  
    animate();
  </script>
  
</body>
</html>
